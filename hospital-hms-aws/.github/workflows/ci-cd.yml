name: CI/CD

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-west-3
  HELM_RELEASE: hms
  HELM_NAMESPACE: hms-prod

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: apps/frontend/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('apps/frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Cache backend dependencies
        uses: actions/cache@v4
        with:
          path: apps/backend/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('apps/backend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-

      - name: Install frontend dependencies
        working-directory: apps/frontend
        run: npm install

      - name: Install backend dependencies
        working-directory: apps/backend
        run: npm install

      - name: Generate Prisma client
        working-directory: apps/backend
        run: npm run prisma:generate

      - name: Run frontend build
        working-directory: apps/frontend
        run: npm run build

      - name: Run backend build
        working-directory: apps/backend
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-oidc-hms
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tag
        id: image-tag
        run: |
          SHORT_SHA=${IMAGE_TAG::7}
          echo "tag=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -t "$ECR_REGISTRY/frontend:$IMAGE_TAG" -f apps/frontend/Dockerfile.production apps/frontend
          docker push "$ECR_REGISTRY/frontend:$IMAGE_TAG"

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -t "$ECR_REGISTRY/backend:$IMAGE_TAG" -f apps/backend/Dockerfile.production apps/backend
          docker push "$ECR_REGISTRY/backend:$IMAGE_TAG"

      - name: Update Helm values with new image tag
        env:
          TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          python -m pip install --quiet pyyaml
          python - <<'PY'
import os
from pathlib import Path
import yaml
path = Path('infra/helm/values.yaml')
data = yaml.safe_load(path.read_text())
data['global']['image']['tag'] = os.environ['TAG']
path.write_text(yaml.safe_dump(data, sort_keys=False))
PY

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name hms-prod --region $AWS_REGION

      - name: Deploy with Helm
        run: |
          helm upgrade --install $HELM_RELEASE infra/helm -n $HELM_NAMESPACE --create-namespace

      - name: Upload Helm package artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-manifests
          path: infra/helm
